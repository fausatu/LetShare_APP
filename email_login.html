<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Connexion par Email - LetShare</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/email_login.css">
</head>
<body>
    <div class="auth-container">
        <!-- Left side - Illustration -->
        <div class="auth-illustration">
            <div class="illustration-content">
                <div class="illustration-icon">
                    <img src="Letshare_Icon.png" alt="LetShare" onerror="this.style.display='none'">
                </div>
                <h2 data-i18n="emailLoginIllustrationTitle">Connexion rapide</h2>
                <p data-i18n="emailLoginIllustrationText">Recevez un code par email et connectez-vous sans mot de passe</p>
            </div>
        </div>
        
        <!-- Right side - Form -->
        <div class="auth-form-section">
            <div class="auth-form-box">
                
                <div class="auth-form-header">
                    <h1 data-i18n="emailLoginTitle">Connexion par Email</h1>
                    <p data-i18n="emailLoginSubtitle">Entrez votre email universitaire</p>
                </div>
                
                <div class="step-indicator">
                    <div class="step" id="step1"></div>
                    <div class="step" id="step2"></div>
                    <div class="step" id="step3"></div>
                </div>
                
                <div class="error-message" id="errorMessage"></div>
                <div class="success-message" id="successMessage"></div>
                
                <!-- Step 1: Email Input -->
                <div id="emailStep">
                    <form id="emailForm">
                        <div class="form-group">
                            <label class="form-label" for="email" data-i18n="universityEmailLabel">Email universitaire</label>
                            <div style="position: relative;">
                                <input type="email" class="form-input" id="email" data-i18n-placeholder="universityEmailPlaceholder" placeholder="votre.email@student.clermont-sb.fr" required>
                                <div id="emailFeedback" style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); font-size: 1.25rem; display: none;"></div>
                            </div>
                            <small style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem; display: block;" data-i18n="onlyUniversityEmailsAccepted">Seuls les emails universitaires sont acceptés (ex: @student.univ.fr, @edu.university.com)</small>
                            <div id="emailValidationMessage" style="font-size: 0.75rem; margin-top: 0.25rem; display: none; padding: 0.5rem; border-radius: 0.375rem;"></div>
                        </div>
                        
                        <button type="submit" class="btn-primary" id="sendCodeBtn" data-i18n="sendCodeButton">Envoyer le code</button>
                    </form>
                </div>
                
                <!-- Step 2: Code Input -->
                <div id="codeStep" style="display: none;">
                    <form id="codeForm">
                        <div class="form-group">
                            <label class="form-label" for="code" data-i18n="verificationCodeLabel">Code de vérification</label>
                            <div class="code-input-group">
                                <input type="text" class="code-input" id="code" placeholder="000000" maxlength="6" required pattern="[0-9]{6}">
                            </div>
                            <p class="countdown" id="countdown"></p>
                        </div>
                        
                        <button type="submit" class="btn-primary" id="verifyCodeBtn" data-i18n="verifyCodeButton">Vérifier le code</button>
                        <button type="button" class="btn-link" id="resendCodeBtn" style="width: 100%; margin-top: 10px;" data-i18n="resendCodeButton">Renvoyer le code</button>
                    </form>
                </div>
                
                <!-- Step 3: Complete Registration (Name and Department) -->
                <div id="completeStep" style="display: none;">
                    <form id="completeForm">
                        <div class="form-group">
                            <label class="form-label" for="name" data-i18n="fullNameLabel">Nom complet</label>
                            <input type="text" class="form-input" id="name" data-i18n-placeholder="fullNamePlaceholder" placeholder="Entrez votre nom complet" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="department" data-i18n="departmentLabel">Département / Filière</label>
                            <input type="text" class="form-input" id="department" data-i18n-placeholder="departmentPlaceholder" placeholder="ex: Finance, Marketing, Management..." required list="departmentSuggestions" autocomplete="off">
                            <datalist id="departmentSuggestions"></datalist>
                            <small style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem; display: block;" data-i18n="startTypingSuggestions">Commencez à taper pour voir les suggestions</small>
                        </div>
                        
                        <button type="submit" class="btn-primary" id="completeBtn" data-i18n="completeRegistrationButton">Finaliser l'inscription</button>
                    </form>
                </div>
                
                <div class="back-link">
                    <a href="login.html" data-i18n="backToLogin">← Retour à la connexion</a>
                </div>
            </div>
        </div>
    </div>
    
    <script src="js/api.js"></script>
    <script>
        // Translations
        const translations = {
            en: {
                emailLoginTitle: "Login with Email",
                emailLoginSubtitle: "Enter your university email",
                emailLoginIllustrationTitle: "Quick Login",
                emailLoginIllustrationText: "Receive a code by email and log in without a password",
                universityEmailLabel: "University Email",
                universityEmailPlaceholder: "your.email@student.university.edu",
                sendCodeButton: "Send Code",
                sendingCode: "Sending...",
                codeSent: "Code sent! Check your email inbox.",
                verificationCodeLabel: "Verification Code",
                verifyCodeButton: "Verify Code",
                verifying: "Verifying...",
                resendCodeButton: "Resend Code",
                resending: "Sending...",
                codeExpired: "Code expired. Click 'Resend Code'",
                codeValidFor: "Code valid for",
                codeMustBe6Digits: "Code must contain exactly 6 digits",
                invalidCode: "Invalid code",
                errorSendingCode: "Error sending code. Please try again.",
                tooManyRequests: "Too many requests. Please wait a few minutes before trying again.",
                errorVerifying: "Error verifying. Please try again.",
                invalidEmailFormat: "Invalid email format.",
                universityNotPartner: "Your university is not yet a partner. Contact us to add your university.",
                useUniversityEmail: "Please use your official university email.",
                personalEmailNotAllowed: "Personal emails are not accepted. Use your university email.",
                genericDomainNotAllowed: "This domain seems generic. Use your official university email.",
                fullNameLabel: "Full Name",
                fullNamePlaceholder: "Enter your full name",
                departmentLabel: "Department / Major",
                departmentPlaceholder: "e.g. Finance, Marketing, Management...",
                startTypingSuggestions: "Start typing to see suggestions",
                completeRegistrationButton: "Complete Registration",
                completing: "Registering...",
                onlyUniversityEmailsAccepted: "Only university emails are accepted (e.g. @student.univ.edu, @edu.university.com)",
                errorCompleting: "Error completing registration. Please try again.",
                backToLogin: "← Back to login",
                universityEmailDetected: "✓ University email detected",
                checkSpamFolder: "Also check your SPAM or Promotions folder!"
            },
            fr: {
                emailLoginTitle: "Connexion par Email",
                emailLoginSubtitle: "Entrez votre email universitaire",
                emailLoginIllustrationTitle: "Connexion rapide",
                emailLoginIllustrationText: "Recevez un code par email et connectez-vous sans mot de passe",
                universityEmailLabel: "Email universitaire",
                universityEmailPlaceholder: "votre.email@student.clermont-sb.fr",
                sendCodeButton: "Envoyer le code",
                sendingCode: "Envoi en cours...",
                codeSent: "Code envoyé ! Vérifiez votre boîte email.",
                verificationCodeLabel: "Code de vérification",
                verifyCodeButton: "Vérifier le code",
                verifying: "Vérification...",
                resendCodeButton: "Renvoyer le code",
                resending: "Envoi...",
                codeExpired: "Code expiré. Cliquez sur 'Renvoyer le code'",
                codeValidFor: "Code valide pendant",
                codeMustBe6Digits: "Le code doit contenir exactement 6 chiffres",
                invalidCode: "Code invalide",
                errorSendingCode: "Erreur lors de l'envoi du code. Veuillez réessayer.",
                tooManyRequests: "Trop de demandes de code. Veuillez attendre quelques minutes avant de réessayer.",
                errorVerifying: "Erreur lors de la vérification. Veuillez réessayer.",
                invalidEmailFormat: "Format d'email invalide.",
                universityNotPartner: "Votre université n'est pas encore partenaire. Contactez-nous pour ajouter votre université.",
                useUniversityEmail: "Veuillez utiliser votre email universitaire officiel.",
                personalEmailNotAllowed: "Les emails personnels ne sont pas acceptés. Utilisez votre email universitaire.",
                genericDomainNotAllowed: "Ce domaine semble générique. Utilisez votre email universitaire officiel.",
                fullNameLabel: "Nom complet",
                fullNamePlaceholder: "Entrez votre nom complet",
                departmentLabel: "Département / Filière",
                departmentPlaceholder: "ex: Finance, Marketing, Management...",
                startTypingSuggestions: "Commencez à taper pour voir les suggestions",
                completeRegistrationButton: "Finaliser l'inscription",
                completing: "Inscription...",
                onlyUniversityEmailsAccepted: "Seuls les emails universitaires sont acceptés (ex: @student.univ.fr, @edu.university.com)",
                errorCompleting: "Erreur lors de l'inscription. Veuillez réessayer.",
                backToLogin: "← Retour à la connexion",
                universityEmailDetected: "✓ Email universitaire détecté",
                checkSpamFolder: "Vérifie aussi ton dossier SPAM ou Promotions!"
            }
        };
        
        // Get current language
        function getCurrentLanguage() {
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            return settings.language || 'fr';
        }
        
        // Get translation
        function t(key) {
            const lang = getCurrentLanguage();
            return translations[lang] && translations[lang][key] ? translations[lang][key] : (translations.en[key] || key);
        }
        
        // Apply translations
        function applyTranslations() {
            const lang = getCurrentLanguage();
            document.documentElement.lang = lang;
            
            // Update language selector if it exists
            const languageSelector = document.getElementById('languageSelector');
            if (languageSelector) {
                languageSelector.value = lang;
            }
            
            // Translate elements with data-i18n
            document.querySelectorAll('[data-i18n]').forEach(function(el) {
                const key = el.getAttribute('data-i18n');
                const translation = t(key);
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    // Don't change input values, only placeholders
                } else if (el.tagName === 'BUTTON' || el.tagName === 'A') {
                    el.textContent = translation;
                } else if (el.tagName === 'SMALL') {
                    el.textContent = translation;
                } else {
                    el.textContent = translation;
                }
            });
            
            // Translate placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });
        }
        
        // Change language
        function changeLanguage(lang) {
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            settings.language = lang;
            localStorage.setItem('userSettings', JSON.stringify(settings));
            applyTranslations();
            
            // Update selected language text (only if element exists)
            const langNames = { fr: 'Français', en: 'English' };
            const selectedLangElement = document.querySelector('.selected-lang');
            if (selectedLangElement) {
                selectedLangElement.textContent = langNames[lang];
            }
            
            // Update selected option styling
            document.querySelectorAll('.language-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.lang === lang) {
                    opt.classList.add('selected');
                }
            });
        }
        
        // Language selector dropdown functionality (only if elements exist)
        const languageSelector = document.getElementById('languageSelector');
        const languageDropdown = document.getElementById('languageDropdown');
        
        if (languageSelector && languageDropdown) {
            languageSelector.addEventListener('click', function(e) {
                e.stopPropagation();
                languageSelector.classList.toggle('active');
                languageDropdown.classList.toggle('active');
            });
            
            document.querySelectorAll('.language-option').forEach(option => {
                option.addEventListener('click', function() {
                    const lang = this.dataset.lang;
                    changeLanguage(lang);
                    languageSelector.classList.remove('active');
                    languageDropdown.classList.remove('active');
                });
            });
            
            // Close dropdown when clicking outside
            document.addEventListener('click', function(e) {
                if (!languageSelector.contains(e.target) && !languageDropdown.contains(e.target)) {
                    languageSelector.classList.remove('active');
                    languageDropdown.classList.remove('active');
                }
            });
        }
        
        // Set initial selected language
        const currentLang = JSON.parse(localStorage.getItem('userSettings') || '{}').language || 'fr';
        changeLanguage(currentLang);
        
        // Initialize translations on page load
        applyTranslations();
        
        // Load university domains for validation
        let universityDomains = [];
        
        async function loadUniversityDomains() {
            try {
                const response = await fetch('api/get_university_domains.php');
                const data = await response.json();
                if (data.success && data.data) {
                    universityDomains = data.data;
                    console.log('Loaded university domains:', universityDomains.length, 'domains');
                }
            } catch (error) {
                console.error('Error loading university domains:', error);
            }
        }
        
        // Load domains on page load
        loadUniversityDomains();
        
        // Real-time email validation feedback
        const emailInput = document.getElementById('email');
        const sendCodeBtn = document.getElementById('sendCodeBtn');
        const emailFeedback = document.getElementById('emailFeedback');
        const emailValidationMessage = document.getElementById('emailValidationMessage');
        
        function updateEmailValidationFeedback() {
            const email = emailInput.value.trim();
            
            if (!email) {
                emailInput.style.borderColor = '';
                emailInput.style.backgroundColor = '';
                emailFeedback.style.display = 'none';
                emailValidationMessage.style.display = 'none';
                sendCodeBtn.disabled = false;
                return;
            }
            
            const validation = validateEmailBeforeSend(email);
            
            if (validation.valid) {
                emailInput.style.borderColor = '#10b981';
                emailInput.style.backgroundColor = '#f0fdf4';
                emailFeedback.textContent = '✓';
                emailFeedback.style.color = '#10b981';
                emailFeedback.style.display = 'block';
                emailValidationMessage.textContent = t('universityEmailDetected');
                emailValidationMessage.style.color = '#10b981';
                emailValidationMessage.style.backgroundColor = '#e6f9f0';
                emailValidationMessage.style.display = 'block';
                sendCodeBtn.disabled = false;
            } else {
                emailInput.style.borderColor = '#dc2626';
                emailInput.style.backgroundColor = '#fef2f2';
                emailFeedback.textContent = '✗';
                emailFeedback.style.color = '#dc2626';
                emailFeedback.style.display = 'block';
                emailValidationMessage.textContent = validation.message;
                emailValidationMessage.style.color = '#dc2626';
                emailValidationMessage.style.backgroundColor = '#fef2f2';
                emailValidationMessage.style.borderColor = '#fca5a5';
                emailValidationMessage.style.border = '1px solid';
                emailValidationMessage.style.display = 'block';
                sendCodeBtn.disabled = true;
            }
        }
        emailInput.addEventListener('input', updateEmailValidationFeedback);  
        emailInput.addEventListener('blur', updateEmailValidationFeedback);       
        let countdownInterval;
        let emailValue = '';
        
        // Validation function for university email
        function validateEmailBeforeSend(email) {
            // Basic format validation
            if (!email || email.trim() === '') {
                return { valid: false, message: t('universityEmailLabel') + ' requis' };
            }
            
            if (!email.includes('@')) {
                return { valid: false, message: t('invalidEmailFormat') };
            }
            
            // Check for valid email format
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                return { valid: false, message: t('invalidEmailFormat') };
            }
            
            // Check for common personal email domains first
            const personalDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'icloud.com', 'aol.com', 'live.com', 'msn.com', 'me.com', 'mac.com'];
            const domain = '@' + email.split('@')[1]?.toLowerCase();
            
            if (personalDomains.includes(domain.substring(1))) {
                return { valid: false, message: t('personalEmailNotAllowed') };
            }
            
            // Check against actual university domains from database
            if (universityDomains.length > 0) {
                const isValidDomain = universityDomains.includes(domain);
                
                if (!isValidDomain) {
                    return { valid: false, message: t('universityNotPartner') };
                }
            } else {
                // Fallback validation if domains haven't loaded yet
                const universityKeywords = ['student', 'univ', 'edu', 'ac.', 'university', 'college', 'ecole', 'school'];
                const isUniversityLike = universityKeywords.some(keyword => domain?.includes(keyword));
                
                if (!isUniversityLike) {
                    return { valid: false, message: t('useUniversityEmail') };
                }
            }
            
            return { valid: true };
        }

        // Email form submission
        document.getElementById('emailForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            emailValue = document.getElementById('email').value.trim();
            const sendCodeBtn = document.getElementById('sendCodeBtn');
            const errorMessage = document.getElementById('errorMessage');
            const successMessage = document.getElementById('successMessage');
            
            // Hide messages
            errorMessage.classList.remove('show');
            successMessage.classList.remove('show');
            
            // Validate email before sending request
            const validation = validateEmailBeforeSend(emailValue);
            if (!validation.valid) {
                errorMessage.textContent = validation.message;
                errorMessage.classList.add('show');
                return;
            }
            
            // Disable button
            sendCodeBtn.disabled = true;
            sendCodeBtn.textContent = t('sendingCode');
            
            try {
                const response = await fetch('api/auth/send_email_code.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email: emailValue })
                });
                
                // Check if response is ok
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Response error:', response.status, response.statusText);
                    console.error('Response body:', text);
                    // Try to parse error message if it's JSON
                    try {
                        const errorData = JSON.parse(text);
                        let errorMessage = errorData.message || t('errorSendingCode');
                        
                        // Provide specific error messages for common issues
                        if (errorMessage.includes('Invalid email format') || errorMessage.includes('Format d\'email invalide')) {
                            errorMessage = t('invalidEmailFormat');
                        } else if (errorMessage.includes('not yet a partner') || errorMessage.includes('university is not') || 
                                 errorMessage.includes('pas encore partenaire') || errorMessage.includes('université n\'est pas')) {
                            errorMessage = t('universityNotPartner');
                        } else if (errorMessage.includes('university email') || errorMessage.includes('email universitaire')) {
                            errorMessage = t('useUniversityEmail');
                        }
                        
                        throw new Error(errorMessage);
                    } catch (e) {
                        // Not JSON, use generic error
                        throw new Error(t('errorSendingCode') + ' (Status: ' + response.status + ')');
                    }
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    
                    // Check if this is anti-bot protection from hosting provider
                    if (text.includes('aes.js') || text.includes('slowAES') || text.includes('__test=')) {
                        throw new Error('Service temporairement indisponible en raison des mesures de sécurité. Veuillez réessayer dans quelques minutes.');
                    }
                    
                    throw new Error(t('errorSendingCode'));
                }
                
                // Try to parse JSON
                let data;
                try {
                    const text = await response.text();
                    if (!text || text.trim() === '') {
                        throw new Error('Empty response from server');
                    }
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error(t('errorSendingCode'));
                }
                
                if (data.success) {
                    // Show success message with spam warning
                    let messageHTML = t('codeSent') + '<div style="display: flex; gap: 8px; align-items: flex-start; margin-top: 12px; padding: 10px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;"><span style="font-size: 16px; flex-shrink: 0;">⚠️</span><div style="font-size: 0.875rem; color: #dc2626;">' + t('checkSpamFolder') + '</div></div>';
                    
                    // In debug mode, show the code directly
                    if (data.debug_code) {
                        messageHTML += '<br><strong style="font-size: 1.5rem; color: #10b981;">Code: ' + data.debug_code + '</strong><br><small style="color: #6b7280;">Mode développement - Le code est affiché ici car l\'email ne peut pas être envoyé en local</small>';
                    }
                    
                    successMessage.innerHTML = messageHTML;
                    successMessage.classList.add('show');
                    
                    // Switch to code step
                    setTimeout(() => {
                        successMessage.classList.remove('show');
                        document.getElementById('emailStep').style.display = 'none';
                        document.getElementById('codeStep').style.display = 'block';
                        document.getElementById('step1').classList.remove('active');
                        document.getElementById('step2').classList.add('active');
                        
                        // Focus on code input
                        document.getElementById('code').focus();
                        
                        // Start countdown
                        startCountdown(600); // 10 minutes
                    }, data.debug_code ? 5000 : 1000); // Wait longer in debug mode to read the code
                } else {
                    throw new Error(data.message || t('errorSendingCode'));
                }
            } catch (error) {
                console.error('Send code error:', error);
                // Check if it's a rate limit error (429)
                let displayMessage = error.message || t('errorSendingCode');
                if (error.message && error.message.includes('429')) {
                    displayMessage = t('tooManyRequests');
                }
                errorMessage.textContent = displayMessage;
                errorMessage.classList.add('show');
            } finally {
                sendCodeBtn.disabled = false;
                sendCodeBtn.textContent = t('sendCodeButton');
            }
        });
        
        // Code form submission
        document.getElementById('codeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            let code = document.getElementById('code').value.trim();
            const verifyCodeBtn = document.getElementById('verifyCodeBtn');
            const errorMessage = document.getElementById('errorMessage');
            
            // Hide messages
            errorMessage.classList.remove('show');
            
            // Clean code: remove all non-digit characters
            code = code.replace(/\D/g, '');
            
            // Update input field with cleaned code
            document.getElementById('code').value = code;
            
            // Validate code format
            if (!/^\d{6}$/.test(code)) {
                errorMessage.textContent = t('codeMustBe6Digits');
                errorMessage.classList.add('show');
                return;
            }
            
            // Hide success message if still visible
            const successMessage = document.getElementById('successMessage');
            successMessage.classList.remove('show');
            
            // Disable button
            verifyCodeBtn.disabled = true;
            verifyCodeBtn.textContent = t('verifying');
            
            try {
                const response = await fetch('api/auth/verify_email_code.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email: emailValue, code: code })
                });
                
                // Check if response is ok
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Response error:', response.status, text);
                    throw new Error(t('errorVerifying'));
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    
                    // Check if this is anti-bot protection from hosting provider
                    if (text.includes('aes.js') || text.includes('slowAES') || text.includes('__test=')) {
                        throw new Error('Service temporairement indisponible en raison des mesures de sécurité. Veuillez réessayer dans quelques minutes.');
                    }
                    
                    throw new Error(t('errorVerifying'));
                }
                
                // Try to parse JSON
                let data;
                try {
                    const text = await response.text();
                    if (!text || text.trim() === '') {
                        throw new Error('Empty response from server');
                    }
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error(t('errorVerifying'));
                }
                
                if (data.success) {
                    // Check if this is a new user who needs to complete registration
                    if (data.data && data.data.is_new_user) {
                        // New user - show completion step
                        document.getElementById('codeStep').style.display = 'none';
                        document.getElementById('completeStep').style.display = 'block';
                        document.getElementById('step2').classList.remove('active');
                        document.getElementById('step3').classList.add('active');
                        
                        // Pre-fill name from email if possible
                        const emailParts = emailValue.split('@')[0];
                        const suggestedName = emailParts.replace(/[._-]/g, ' ').split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                        document.getElementById('name').value = suggestedName;
                        
                        // Load departments for autocomplete
                        loadDepartments();
                    } else {
                        // Existing user - log in directly
                        if (data.data && data.data.user) {
                            localStorage.setItem('currentUser', JSON.stringify(data.data.user));
                            localStorage.setItem('authToken', data.data.token);
                        }
                        
                        // Redirect to main page
                        window.location.href = 'index.html';
                    }
                } else {
                    // Show the actual error message from server
                    errorMessage.textContent = data.message || t('invalidCode');
                    errorMessage.classList.add('show');
                    document.getElementById('code').value = '';
                    document.getElementById('code').focus();
                }
            } catch (error) {
                console.error('Error:', error);
                errorMessage.textContent = error.message || t('errorVerifying');
                errorMessage.classList.add('show');
                document.getElementById('code').value = '';
                document.getElementById('code').focus();
            } finally {
                verifyCodeBtn.disabled = false;
                verifyCodeBtn.textContent = t('verifyCodeButton');
            }
        });
        
        // Resend code
        document.getElementById('resendCodeBtn').addEventListener('click', async function() {
            const resendBtn = this;
            const errorMessage = document.getElementById('errorMessage');
            const emailValue = document.getElementById('email').value.trim();
            
            errorMessage.classList.remove('show');
            resendBtn.disabled = true;
            resendBtn.textContent = t('resending');
            
            try {
                const response = await fetch('api/auth/send_email_code.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ email: emailValue })
                });
                
                // Check if response is ok
                if (!response.ok) {
                    const text = await response.text();
                    console.error('Response error:', response.status, text);
                    throw new Error(t('errorSendingCode'));
                }
                
                // Check content type
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Non-JSON response:', text);
                    
                    // Check if this is anti-bot protection from hosting provider
                    if (text.includes('aes.js') || text.includes('slowAES') || text.includes('__test=')) {
                        throw new Error('Service temporairement indisponible en raison des mesures de sécurité. Veuillez réessayer dans quelques minutes.');
                    }
                    
                    throw new Error(t('errorSendingCode'));
                }
                
                // Try to parse JSON
                let data;
                try {
                    const text = await response.text();
                    if (!text || text.trim() === '') {
                        throw new Error('Empty response from server');
                    }
                    data = JSON.parse(text);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError);
                    throw new Error(t('errorSendingCode'));
                }
                
                if (data.success) {
                    // Reset countdown
                    clearInterval(countdownInterval);
                    startCountdown(600);
                    
                    // Clear code input
                    document.getElementById('code').value = '';
                    document.getElementById('code').focus();
                } else {
                    throw new Error(data.message || t('errorSendingCode'));
                }
            } catch (error) {
                console.error('Resend code error:', error);
                errorMessage.textContent = error.message || t('errorSendingCode');
                errorMessage.classList.add('show');
            } finally {
                resendBtn.disabled = false;
                resendBtn.textContent = t('resendCodeButton');
            }
        });
        
        // Auto-format code input (only numbers)
        document.getElementById('code').addEventListener('input', function(e) {
            this.value = this.value.replace(/\D/g, '');
        });
        
        // Start countdown timer
        function startCountdown(seconds) {
            const countdownEl = document.getElementById('countdown');
            let remaining = seconds;
            
            function updateCountdown() {
                const minutes = Math.floor(remaining / 60);
                const secs = remaining % 60;
                countdownEl.textContent = `${t('codeValidFor')} ${minutes}:${secs.toString().padStart(2, '0')}`;
                
                if (remaining <= 0) {
                    clearInterval(countdownInterval);
                    countdownEl.textContent = t('codeExpired');
                    countdownEl.style.color = '#dc2626';
                } else {
                    remaining--;
                }
            }
            
            updateCountdown();
            countdownInterval = setInterval(updateCountdown, 1000);
        }
        
        // Load departments for autocomplete
        async function loadDepartments() {
            try {
                const response = await fetch('api/departments.php');
                const data = await response.json();
                if (data.success && data.data) {
                    const datalist = document.getElementById('departmentSuggestions');
                    datalist.innerHTML = '';
                    data.data.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept;
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }
        
        // Complete registration form submission
        document.getElementById('completeForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const department = document.getElementById('department').value.trim();
            const completeBtn = document.getElementById('completeBtn');
            const errorMessage = document.getElementById('errorMessage');
            
            // Validation
            if (!name || !department) {
                errorMessage.textContent = t('fillAllFields');
                errorMessage.classList.add('show');
                return;
            }
            
            // Hide messages
            errorMessage.classList.remove('show');
            
            // Disable button
            completeBtn.disabled = true;
            completeBtn.textContent = t('completing');
            
            try {
                const response = await fetch('api/auth/complete_email_registration.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    credentials: 'include',
                    body: JSON.stringify({ 
                        email: emailValue, 
                        name: name, 
                        department: department 
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Store user data
                    if (data.data && data.data.user) {
                        localStorage.setItem('currentUser', JSON.stringify(data.data.user));
                        localStorage.setItem('authToken', data.data.token);
                    }
                    
                    // Redirect to main page
                    window.location.href = 'index.html';
                } else {
                    throw new Error(data.message || t('errorCompleting'));
                }
            } catch (error) {
                errorMessage.textContent = error.message || t('errorCompleting');
                errorMessage.classList.add('show');
            } finally {
                completeBtn.disabled = false;
                completeBtn.textContent = t('completeRegistrationButton');
            }
        });
        
        // Check for error messages from URL
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('error')) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = decodeURIComponent(urlParams.get('error'));
            errorMessage.classList.add('show');
        }
    </script>
</body>
</html>

