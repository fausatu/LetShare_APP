<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscription - LetShare</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/auth.css">
</head>
<body>
    <div class="auth-container">
        <!-- Left side - Illustration -->
        <div class="auth-illustration">
            <div class="illustration-content">
                <div class="illustration-icon">
                    <H1 class="illustration-title">LetShare</H1>
                </div>
                <h2 data-i18n="registerIllustrationTitle">La plateforme d'échange entre étudiants</h2>
                <p data-i18n="registerIllustrationText">Rejoignez des milliers d'étudiants qui donnent, troquent et partagent. Pratiquez l'économie collaborative sur votre campus.</p>
            </div>
        </div>
        
        <!-- Right side - Form -->
        <div class="auth-form-section">
            <div class="auth-form-box">
                <!-- Language Selector -->
                <div class="language-selector-wrapper">
                    <div class="language-selector" id="languageSelector">
                        <span class="selected-lang">Français</span>
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 9L1 4h10z" fill="#10b981"/>
                        </svg>
                    </div>
                    <div class="language-dropdown" id="languageDropdown">
                        <div class="language-option" data-lang="fr">Français</div>
                        <div class="language-option" data-lang="en">English</div>
                    </div>
                </div>
                
                <div class="auth-form-header">
                    <div class="logo">
                        <!-- <img src="Letshare_Icon.png" alt="LetShare Logo"> -->
                        <!-- <span style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">LetShare</span> -->
                    </div>
                    <h1 data-i18n="registerTitle">Rejoignez la communauté d'échange entre étudiants</h1>
                    <p data-i18n="registerSubtitle">Créez votre compte gratuit et commencez à donner, troquer et partager</p>
                </div>
                
                <div class="error-message" id="errorMessage"></div>
                <!-- Success Message with Spam Warning -->
                <div class="success-message" id="successMessage" style="display: none; background: #f0fdf4; border: 1px solid #86efac; border-radius: 12px; padding: 16px; margin-bottom: 20px;">
                    <div style="display: flex; gap: 12px; align-items: flex-start;">
                        <span style="font-size: 24px; flex-shrink: 0;">✓</span>
                        <div style="font-size: 15px; color: #166534; line-height: 1.5;">
                            <strong>Email envoyé!</strong><br>
                            Vérifie ton mail de confirmation. <strong>N'oublie pas de vérifier ton dossier SPAM!</strong>
                        </div>
                    </div>
                    <!-- Spam Warning (soft red) -->
                    <div style="display: flex; gap: 8px; align-items: flex-start; margin-top: 12px; padding: 10px; background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px;">
                        <span style="font-size: 16px; flex-shrink: 0;">⚠️</span>
                        <div style="font-size: 0.875rem; color: #dc2626;">N'oublie pas dossier <strong>SPAM</strong> ou <strong>Promotions</strong>!</div>
                    </div>
                </div>
                
                <!-- Quick Registration Options (Email-first approach) -->
                <div class="quick-register-section" style="margin-bottom: 2rem;">
                    <h3 style="color: #1f2937; font-size: 1.125rem; font-weight: 600; margin-bottom: 1rem; text-align: center;" data-i18n="quickRegisterTitle">Quick Registration</h3>
                    
                    <button type="button" class="btn-google" id="btnEmailAuth" style="width: 100%; padding: 0.875rem; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 0.75rem; color: white; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        <span data-i18n="registerWithEmail">Register with Email</span>
                    </button>
                </div>
                
                <!-- Alternative: Complete Form -->
                <div class="divider" style="text-align: center; margin: 2rem 0; position: relative;">
                    <div style="height: 1px; background: #e5e7eb; position: absolute; top: 50%; left: 0; right: 0;"></div>
                    <button type="button" class="toggle-complete-form" id="toggleCompleteForm" style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 1rem; padding: 0.5rem 1rem; color: #6b7280; font-size: 0.875rem; cursor: pointer; position: relative; z-index: 1; transition: all 0.3s;" data-i18n="showCompleteForm">
                        Or fill complete form ↓
                    </button>
                </div>
                
                <!-- Complete Registration Form (Hidden by default) -->
                <div class="complete-form-section" id="completeFormSection" style="display: none;">
                    <form id="registerForm">
                        <div class="form-group">
                            <label class="form-label" for="name" data-i18n="fullNameLabel">Nom complet</label>
                            <input type="text" class="form-input" id="name" data-i18n-placeholder="fullNamePlaceholder" placeholder="Entrez votre nom complet" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="email" data-i18n="universityEmailLabel">Email universitaire</label>
                            <input type="email" class="form-input" id="email" data-i18n-placeholder="universityEmailPlaceholder" placeholder="votre.email@student.clermont-sb.fr" required>
                            <small style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem; display: block;" data-i18n="onlyUniversityEmails">Seuls les emails universitaires sont acceptés</small>
                            <div id="emailValidation" style="display: none; margin-top: 0.5rem; font-size: 0.875rem;"></div>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="password" data-i18n="passwordLabel">Mot de passe</label>
                            <input type="password" class="form-input" id="password" data-i18n-placeholder="passwordPlaceholderRegister" placeholder="Entrez votre mot de passe (min 6 caractères)" required minlength="6">
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label" for="department" data-i18n="departmentLabel">Département / Filière</label>
                            <input type="text" class="form-input" id="department" data-i18n-placeholder="departmentPlaceholder" placeholder="ex: Finance, Marketing, Management..." required list="departmentSuggestions" autocomplete="off">
                            <datalist id="departmentSuggestions"></datalist>
                            <small style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem; display: block;" data-i18n="startTypingSuggestions">Commencez à taper pour voir les suggestions</small>
                        </div>
                        
                        <!-- Terms and Privacy Consent -->
                        <div class="form-group" style="margin-top: 1.5rem;">
                            <label style="display: flex; align-items: flex-start; gap: 0.75rem; cursor: pointer; user-select: none;">
                                <input type="checkbox" id="termsConsent" style="margin-top: 0.25rem; width: 1.125rem; height: 1.125rem; cursor: pointer; accent-color: #10b981;" required>
                                <span style="color: #4b5563; font-size: 0.875rem; line-height: 1.6;">
                                    <span data-i18n="acceptTermsText">J'ai lu et j'accepte les</span>
                                    <a href="#" onclick="openTermsInLanguage(); return false;" style="color: #10b981; font-weight: 600; text-decoration: underline;" data-i18n="termsOfService">Conditions Générales d'Utilisation</a>
                                    <span data-i18n="andText"> et la </span>
                                    <a href="#" onclick="openPrivacyInLanguage(); return false;" style="color: #10b981; font-weight: 600; text-decoration: underline;" data-i18n="privacyPolicy">Politique de confidentialité</a>
                                </span>
                            </label>
                        </div>
                        
                        <button type="submit" class="btn-register" id="registerBtn" data-i18n="registerButton" disabled style="opacity: 0.5; cursor: not-allowed;">S'inscrire</button>
                    </form>
                </div>
                
                <div class="login-link">
                    <span data-i18n="alreadyHaveAccount">Vous avez déjà un compte ?</span> <a href="login.html" data-i18n="loginHere">Connectez-vous ici</a>
                </div>
            </div>
        </div>
    </div>
    
    <script src="js/api.js"></script>
    <script>
        // Translations
        const translations = {
            en: {
                registerTitle: "Join the Student Exchange Community",
                registerSubtitle: "Create your free account and start donating, trading and sharing",
                registerIllustrationTitle: "The Student Exchange Platform",
                registerIllustrationText: "Join thousands of students who donate, trade and share. Practice the collaborative economy on your campus.",
                quickRegisterTitle: "Quick Registration",
                showCompleteForm: "Or fill complete form",
                hideCompleteForm: "Hide complete form",
                fullNameLabel: "Full Name",
                fullNamePlaceholder: "Enter your full name",
                universityEmailLabel: "University Email",
                universityEmailPlaceholder: "your.email@student.university.edu",
                onlyUniversityEmails: "Only university email addresses are accepted",
                passwordLabel: "Password",
                passwordPlaceholderRegister: "Enter your password (min 6 characters)",
                departmentLabel: "Department / Major",
                departmentPlaceholder: "e.g. Finance, Marketing, Management...",
                startTypingSuggestions: "Start typing to see suggestions",
                registerButton: "Register",
                registering: "Registering...",
                registerFailed: "Registration failed",
                registerFailedTryAgain: "Registration failed. Please try again.",
                registerSuccess: "Registration successful! Please check your email to verify your account.",
                verifyEmailMessage: "Please check your email to verify your account.",
                or: "or",
                registerWithEmail: "Register with Email",
                alreadyHaveAccount: "Already have an account?",
                loginHere: "Login here",
                fillAllFields: "Please fill in all fields",
                pleaseEnterValidEmail: "Please enter a valid email address",
                pleaseUseUniversityEmail: "Please use your university email address",
                universityEmailDetected: "✓ University email detected",
                acceptTermsText: "I have read and accept the",
                termsOfService: "Terms of Service",
                andText: " and the ",
                privacyPolicy: "Privacy Policy",
                mustAcceptTerms: "You must accept the Terms of Service and Privacy Policy to register"
            },
            fr: {
                registerTitle: "Rejoignez la communauté d'échange entre étudiants",
                registerSubtitle: "Créez votre compte gratuit et commencez à donner, troquer et partager",
                registerIllustrationTitle: "La plateforme d'échange entre étudiants",
                registerIllustrationText: "Rejoignez des milliers d'étudiants qui donnent, troquent et partagent. Pratiquez l'économie collaborative sur votre campus.",
                quickRegisterTitle: "Inscription Rapide",
                showCompleteForm: "Ou remplir le formulaire complet",
                hideCompleteForm: "Masquer le formulaire complet",
                fullNameLabel: "Nom complet",
                fullNamePlaceholder: "Entrez votre nom complet",
                universityEmailLabel: "Email universitaire",
                universityEmailPlaceholder: "votre.email@student.clermont-sb.fr",
                onlyUniversityEmails: "Seuls les emails universitaires sont acceptés",
                passwordLabel: "Mot de passe",
                passwordPlaceholderRegister: "Entrez votre mot de passe (min 6 caractères)",
                departmentLabel: "Département / Filière",
                departmentPlaceholder: "ex: Finance, Marketing, Management...",
                startTypingSuggestions: "Commencez à taper pour voir les suggestions",
                registerButton: "S'inscrire",
                registering: "Inscription...",
                registerFailed: "Échec de l'inscription",
                registerFailedTryAgain: "Échec de l'inscription. Veuillez réessayer.",
                registerSuccess: "Inscription réussie ! Veuillez vérifier votre email pour confirmer votre compte.",
                verifyEmailMessage: "Veuillez vérifier votre email pour confirmer votre compte.",
                or: "ou",
                registerWithEmail: "S'inscrire avec Email",
                alreadyHaveAccount: "Vous avez déjà un compte ?",
                loginHere: "Connectez-vous ici",
                fillAllFields: "Veuillez remplir tous les champs",
                pleaseEnterValidEmail: "Veuillez entrer une adresse email valide",
                pleaseUseUniversityEmail: "Veuillez utiliser votre email universitaire",
                universityEmailDetected: "✓ Email universitaire détecté",
                acceptTermsText: "J'ai lu et j'accepte les",
                termsOfService: "Conditions Générales d'Utilisation",
                andText: " et la ",
                privacyPolicy: "Politique de confidentialité",
                mustAcceptTerms: "Vous devez accepter les Conditions Générales d'Utilisation et la Politique de confidentialité pour vous inscrire"
            }
        };
        
        // Get current language
        function getCurrentLanguage() {
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            return settings.language || 'fr';
        }
        
        // Get translation
        function t(key) {
            const lang = getCurrentLanguage();
            return translations[lang] && translations[lang][key] ? translations[lang][key] : (translations.en[key] || key);
        }
        
        // Apply translations
        function applyTranslations() {
            const lang = getCurrentLanguage();
            document.documentElement.lang = lang;
            document.getElementById('languageSelector').value = lang;
            
            // Translate elements with data-i18n
            document.querySelectorAll('[data-i18n]').forEach(function(el) {
                const key = el.getAttribute('data-i18n');
                const translation = t(key);
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    // Don't change input values, only placeholders
                } else if (el.tagName === 'BUTTON' || el.tagName === 'A') {
                    const svg = el.querySelector('svg');
                    if (svg) {
                        el.innerHTML = '';
                        el.appendChild(svg);
                        el.appendChild(document.createTextNode(translation));
                    } else {
                        el.textContent = translation;
                    }
                } else if (el.tagName === 'SMALL') {
                    el.textContent = translation;
                } else {
                    el.textContent = translation;
                }
            });
            
            // Translate placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });
        }
        
        // Change language
        function changeLanguage(lang) {
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            settings.language = lang;
            localStorage.setItem('userSettings', JSON.stringify(settings));
            applyTranslations();
            
            // Update selected language text
            const langNames = { fr: 'Français', en: 'English' };
            document.querySelector('.selected-lang').textContent = langNames[lang];
            
            // Update selected option styling
            document.querySelectorAll('.language-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.lang === lang) {
                    opt.classList.add('selected');
                }
            });
        }
        
        // Language selector dropdown functionality
        const languageSelector = document.getElementById('languageSelector');
        const languageDropdown = document.getElementById('languageDropdown');
        
        languageSelector.addEventListener('click', function(e) {
            e.stopPropagation();
            languageSelector.classList.toggle('active');
            languageDropdown.classList.toggle('active');
        });
        
        document.querySelectorAll('.language-option').forEach(option => {
            option.addEventListener('click', function() {
                const lang = this.dataset.lang;
                changeLanguage(lang);
                languageSelector.classList.remove('active');
                languageDropdown.classList.remove('active');
            });
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!languageSelector.contains(e.target) && !languageDropdown.contains(e.target)) {
                languageSelector.classList.remove('active');
                languageDropdown.classList.remove('active');
            }
        });
        
        // Set initial selected language
        const currentLang = JSON.parse(localStorage.getItem('userSettings') || '{}').language || 'fr';
        changeLanguage(currentLang);
        
        // Initialize translations on page load
        applyTranslations();
        
        // Terms consent checkbox functionality
        const termsConsent = document.getElementById('termsConsent');
        const registerBtn = document.getElementById('registerBtn');
        
        termsConsent.addEventListener('change', function() {
            if (this.checked) {
                registerBtn.disabled = false;
                registerBtn.style.opacity = '1';
                registerBtn.style.cursor = 'pointer';
            } else {
                registerBtn.disabled = true;
                registerBtn.style.opacity = '0.5';
                registerBtn.style.cursor = 'not-allowed';
            }
        });
        
        // Load departments for autocomplete
        async function loadDepartments() {
            try {
                const response = await fetch('api/departments.php');
                const data = await response.json();
                if (data.success && data.data) {
                    const datalist = document.getElementById('departmentSuggestions');
                    datalist.innerHTML = '';
                    data.data.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept;
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }
        
        // Validate university email in real-time
        const emailInput = document.getElementById('email');
        const emailValidation = document.getElementById('emailValidation');
        
        emailInput.addEventListener('blur', async function() {
            const email = emailInput.value.trim();
            if (!email) return;
            
            // Basic email format check
            if (!email.includes('@')) {
                emailValidation.style.display = 'block';
                emailValidation.style.color = '#dc2626';
                emailValidation.textContent = t('pleaseEnterValidEmail');
                return;
            }
            
            // Extract domain
            const domain = '@' + email.split('@')[1];
            
            // Check if it's a common personal email domain (basic check)
            const personalDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'icloud.com', 'aol.com'];
            if (personalDomains.some(d => email.toLowerCase().includes('@' + d))) {
                emailValidation.style.display = 'block';
                emailValidation.style.color = '#dc2626';
                emailValidation.textContent = t('pleaseUseUniversityEmail');
                return;
            }
            
            // If it looks like a university email, show positive feedback
            if (email.includes('@student.') || email.includes('@univ.') || email.includes('@edu.')) {
                emailValidation.style.display = 'block';
                emailValidation.style.color = '#10b981';
                emailValidation.textContent = t('universityEmailDetected');
            } else {
                emailValidation.style.display = 'none';
            }
        });
        
        // Load departments on page load
        loadDepartments();
        
        // Email registration button
        document.getElementById('btnEmailAuth').addEventListener('click', function() {
            // Redirect to email login page (works for both login and registration)
            window.location.href = 'email_login.html';
        });
        
        // Check if user has a registration message
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('error')) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = decodeURIComponent(urlParams.get('error'));
            errorMessage.classList.add('show');
        }
        
        // Form submission
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const department = document.getElementById('department').value.trim();
            const termsConsent = document.getElementById('termsConsent');
            const registerBtn = document.getElementById('registerBtn');
            const errorMessage = document.getElementById('errorMessage');
            
            // Check terms consent
            if (!termsConsent.checked) {
                errorMessage.textContent = t('mustAcceptTerms');
                errorMessage.classList.add('show');
                return;
            }
            
            // Validation
            if (!name || !email || !department) {
                errorMessage.textContent = t('fillAllFields');
                errorMessage.classList.add('show');
                return;
            }
            
            // Password required
            if (!password || password.length < 6) {
                errorMessage.textContent = t('passwordTooShort') || 'Le mot de passe doit contenir au moins 6 caractères';
                errorMessage.classList.add('show');
                return;
            }
            
            // Disable button
            registerBtn.disabled = true;
            registerBtn.textContent = t('registering');
            errorMessage.classList.remove('show');
            
            try {
                // Get current language preference
                const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
                const language = settings.language || 'fr';
                
                const response = await authAPI.register({
                    name: name,
                    email: email,
                    password: password,
                    department: department,
                    language: language,
                    termsAccepted: termsConsent.checked // Send consent status
                });
                
                if (response.success) {
                    // Check if email is verified
                    if (response.data.email_verified) {
                        // Store user data
                        localStorage.setItem('currentUser', JSON.stringify(response.data.user));
                        localStorage.setItem('authToken', response.data.token);
                        
                        // Redirect to main page
                        window.location.href = 'index.html';
                    } else {
                        // Email not verified - show message and redirect to login
                        errorMessage.textContent = response.message || t('registerSuccess');
                        errorMessage.style.background = '#f0fdf4';
                        errorMessage.style.borderColor = '#10b981';
                        errorMessage.style.color = '#059669';
                        errorMessage.classList.add('show');
                        
                        // Redirect to login after 3 seconds
                        setTimeout(() => {
                            window.location.href = 'login.html?message=' + encodeURIComponent(t('verifyEmailMessage'));
                        }, 3000);
                    }
                } else {
                    throw new Error(response.message || t('registerFailed'));
                }
            } catch (error) {
                errorMessage.textContent = error.message || t('registerFailedTryAgain');
                errorMessage.classList.add('show');
                registerBtn.disabled = false;
                registerBtn.textContent = t('registerButton');
            }
        });
        
        // Toggle complete form functionality
        document.getElementById('toggleCompleteForm').addEventListener('click', function() {
            var completeFormSection = document.getElementById('completeFormSection');
            var toggleButton = document.getElementById('toggleCompleteForm');
            
            if (completeFormSection.style.display === 'none' || completeFormSection.style.display === '') {
                completeFormSection.style.display = 'block';
                toggleButton.innerHTML = t('hideCompleteForm') + ' ↑';
                toggleButton.style.background = '#fef2f2';
                toggleButton.style.borderColor = '#fecaca';
                toggleButton.style.color = '#dc2626';
            } else {
                completeFormSection.style.display = 'none';
                toggleButton.innerHTML = t('showCompleteForm') + ' ↓';
                toggleButton.style.background = '#f9fafb';
                toggleButton.style.borderColor = '#e5e7eb';
                toggleButton.style.color = '#6b7280';
            }
        });
    </script>
</body>
</html>

