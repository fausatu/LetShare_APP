<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Inscription - LetShare</title>
    <link rel="stylesheet" href="css/main.css">
    <link rel="stylesheet" href="css/auth.css">
</head>
<body>
    <div class="auth-container">
        <!-- Left side - Illustration -->
        <div class="auth-illustration">
            <div class="illustration-content">
                <div class="illustration-icon">
                    <H1 class="illustration-title">LetShare</H1>
                </div>
                <h2 data-i18n="registerIllustrationTitle">Rejoignez votre communauté</h2>
                <p data-i18n="registerIllustrationText">Recevez des offres attractives de la communauté. Partagez, échangez et grandissez ensemble avec les étudiants autour de vous.</p>
            </div>
        </div>
        
        <!-- Right side - Form -->
        <div class="auth-form-section">
            <div class="auth-form-box" style="position: relative;">
                <!-- Language Selector -->
                <div style="position: absolute; top: 20px; right: 20px; z-index: 10;">
                    <select id="languageSelector" style="padding: 0.5rem 1rem; border: 2px solid #e5e7eb; border-radius: 0.5rem; background: white; color: #1f2937; font-size: 0.875rem; cursor: pointer; outline: none;" onchange="changeLanguage(this.value)">
                        <option value="fr">Français</option>
                        <option value="en">English</option>
                    </select>
                </div>
                
                <div class="auth-form-header">
                    <div class="logo">
                        <!-- <img src="Letshare_Icon.png" alt="LetShare Logo"> -->
                        <!-- <span style="font-size: 1.5rem; font-weight: 700; color: #1f2937;">LetShare</span> -->
                    </div>
                    <h1 data-i18n="registerTitle">Créez votre compte</h1>
                    <p data-i18n="registerSubtitle">Rejoignez LetShare et commencez à partager avec votre communauté</p>
                </div>
                
                <div class="error-message" id="errorMessage"></div>
                
                <form id="registerForm">
                    <div class="form-group">
                        <label class="form-label" for="name" data-i18n="fullNameLabel">Nom complet</label>
                        <input type="text" class="form-input" id="name" data-i18n-placeholder="fullNamePlaceholder" placeholder="Entrez votre nom complet" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="email" data-i18n="universityEmailLabel">Email universitaire</label>
                        <input type="email" class="form-input" id="email" data-i18n-placeholder="universityEmailPlaceholder" placeholder="votre.email@student.clermont-sb.fr" required>
                        <small style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem; display: block;" data-i18n="onlyUniversityEmails">Seuls les emails universitaires sont acceptés</small>
                        <div id="emailValidation" style="display: none; margin-top: 0.5rem; font-size: 0.875rem;"></div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="password" data-i18n="passwordLabel">Mot de passe</label>
                        <input type="password" class="form-input" id="password" data-i18n-placeholder="passwordPlaceholderRegister" placeholder="Entrez votre mot de passe (min 6 caractères)" required minlength="6">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="department" data-i18n="departmentLabel">Département / Filière</label>
                        <input type="text" class="form-input" id="department" data-i18n-placeholder="departmentPlaceholder" placeholder="ex: Finance, Marketing, Management..." required list="departmentSuggestions" autocomplete="off">
                        <datalist id="departmentSuggestions"></datalist>
                        <small style="color: #6b7280; font-size: 0.75rem; margin-top: 0.25rem; display: block;" data-i18n="startTypingSuggestions">Commencez à taper pour voir les suggestions</small>
                        <button type="submit" class="btn-register" id="registerBtn" data-i18n="registerButton">S'inscrire</button>
 
                    </div>
                    
                    <div style="margin: 1.5rem 0; text-align: center; color: #9ca3af; font-size: 0.875rem;" data-i18n="or">ou</div>
                    
                    <button type="button" class="btn-google" id="btnGoogleAuth" style="width: 100%; padding: 0.875rem; background: #ffffff; border: 2px solid #e5e7eb; border-radius: 0.75rem; color: #1f2937; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24">
                            <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                            <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                            <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                            <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                        </svg>
                        <span data-i18n="continueWithGoogle">Continuer avec Google</span>
                    </button>
                    
                    <button type="button" class="btn-google" id="btnEmailAuth" style="width: 100%; padding: 0.875rem; background: linear-gradient(135deg, #10b981, #059669); border: none; border-radius: 0.75rem; color: white; font-weight: 600; font-size: 1rem; cursor: pointer; transition: all 0.3s; margin-bottom: 1.5rem; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/>
                            <polyline points="22,6 12,13 2,6"/>
                        </svg>
                        <span data-i18n="registerWithEmail">S'inscrire avec Email</span>
                    </button>
                    
                </form>
                
                <div class="login-link">
                    <span data-i18n="alreadyHaveAccount">Vous avez déjà un compte ?</span> <a href="login.html" data-i18n="loginHere">Connectez-vous ici</a>
                </div>
            </div>
        </div>
    </div>
    
    <script src="js/api.js"></script>
    <script>
        // Translations
        const translations = {
            en: {
                registerTitle: "Create your Account",
                registerSubtitle: "Join LetShare and start sharing with your community",
                registerIllustrationTitle: "Join your community",
                registerIllustrationText: "Get attractive offers from the community. Share, exchange, and grow together with students around you.",
                fullNameLabel: "Full Name",
                fullNamePlaceholder: "Enter your full name",
                universityEmailLabel: "University Email",
                universityEmailPlaceholder: "your.email@student.university.edu",
                onlyUniversityEmails: "Only university email addresses are accepted",
                passwordLabel: "Password",
                passwordPlaceholderRegister: "Enter your password (min 6 characters)",
                departmentLabel: "Department / Major",
                departmentPlaceholder: "e.g. Finance, Marketing, Management...",
                startTypingSuggestions: "Start typing to see suggestions",
                registerButton: "Register",
                registering: "Registering...",
                registerFailed: "Registration failed",
                registerFailedTryAgain: "Registration failed. Please try again.",
                registerSuccess: "Registration successful! Please check your email to verify your account.",
                verifyEmailMessage: "Please check your email to verify your account.",
                or: "or",
                continueWithGoogle: "Continue with Google",
                registerWithEmail: "Register with Email",
                alreadyHaveAccount: "Already have an account?",
                loginHere: "Login here",
                fillAllFields: "Please fill in all fields",
                pleaseEnterValidEmail: "Please enter a valid email address",
                pleaseUseUniversityEmail: "Please use your university email address",
                universityEmailDetected: "✓ University email detected",
                googleAuthSuccess: "✓ Google authentication successful! Please complete your registration by filling in your department."
            },
            fr: {
                registerTitle: "Créez votre compte",
                registerSubtitle: "Rejoignez LetShare et commencez à partager avec votre communauté",
                registerIllustrationTitle: "Rejoignez votre communauté",
                registerIllustrationText: "Recevez des offres attractives de la communauté. Partagez, échangez et grandissez ensemble avec les étudiants autour de vous.",
                fullNameLabel: "Nom complet",
                fullNamePlaceholder: "Entrez votre nom complet",
                universityEmailLabel: "Email universitaire",
                universityEmailPlaceholder: "votre.email@student.clermont-sb.fr",
                onlyUniversityEmails: "Seuls les emails universitaires sont acceptés",
                passwordLabel: "Mot de passe",
                passwordPlaceholderRegister: "Entrez votre mot de passe (min 6 caractères)",
                departmentLabel: "Département / Filière",
                departmentPlaceholder: "ex: Finance, Marketing, Management...",
                startTypingSuggestions: "Commencez à taper pour voir les suggestions",
                registerButton: "S'inscrire",
                registering: "Inscription...",
                registerFailed: "Échec de l'inscription",
                registerFailedTryAgain: "Échec de l'inscription. Veuillez réessayer.",
                registerSuccess: "Inscription réussie ! Veuillez vérifier votre email pour confirmer votre compte.",
                verifyEmailMessage: "Veuillez vérifier votre email pour confirmer votre compte.",
                or: "ou",
                continueWithGoogle: "Continuer avec Google",
                registerWithEmail: "S'inscrire avec Email",
                alreadyHaveAccount: "Vous avez déjà un compte ?",
                loginHere: "Connectez-vous ici",
                fillAllFields: "Veuillez remplir tous les champs",
                pleaseEnterValidEmail: "Veuillez entrer une adresse email valide",
                pleaseUseUniversityEmail: "Veuillez utiliser votre email universitaire",
                universityEmailDetected: "✓ Email universitaire détecté",
                googleAuthSuccess: "✓ Authentification Google réussie ! Veuillez compléter votre inscription en remplissant votre département."
            }
        };
        
        // Get current language
        function getCurrentLanguage() {
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            return settings.language || 'fr';
        }
        
        // Get translation
        function t(key) {
            const lang = getCurrentLanguage();
            return translations[lang] && translations[lang][key] ? translations[lang][key] : (translations.en[key] || key);
        }
        
        // Apply translations
        function applyTranslations() {
            const lang = getCurrentLanguage();
            document.documentElement.lang = lang;
            document.getElementById('languageSelector').value = lang;
            
            // Translate elements with data-i18n
            document.querySelectorAll('[data-i18n]').forEach(function(el) {
                const key = el.getAttribute('data-i18n');
                const translation = t(key);
                if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                    // Don't change input values, only placeholders
                } else if (el.tagName === 'BUTTON' || el.tagName === 'A') {
                    const svg = el.querySelector('svg');
                    if (svg) {
                        el.innerHTML = '';
                        el.appendChild(svg);
                        el.appendChild(document.createTextNode(translation));
                    } else {
                        el.textContent = translation;
                    }
                } else if (el.tagName === 'SMALL') {
                    el.textContent = translation;
                } else {
                    el.textContent = translation;
                }
            });
            
            // Translate placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(function(el) {
                const key = el.getAttribute('data-i18n-placeholder');
                el.placeholder = t(key);
            });
        }
        
        // Change language
        function changeLanguage(lang) {
            const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
            settings.language = lang;
            localStorage.setItem('userSettings', JSON.stringify(settings));
            applyTranslations();
        }
        
        // Initialize translations on page load
        applyTranslations();
        
        // Load departments for autocomplete
        async function loadDepartments() {
            try {
                const response = await fetch('api/departments.php');
                const data = await response.json();
                if (data.success && data.data) {
                    const datalist = document.getElementById('departmentSuggestions');
                    datalist.innerHTML = '';
                    data.data.forEach(dept => {
                        const option = document.createElement('option');
                        option.value = dept;
                        datalist.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading departments:', error);
            }
        }
        
        // Validate university email in real-time
        const emailInput = document.getElementById('email');
        const emailValidation = document.getElementById('emailValidation');
        
        emailInput.addEventListener('blur', async function() {
            const email = emailInput.value.trim();
            if (!email) return;
            
            // Basic email format check
            if (!email.includes('@')) {
                emailValidation.style.display = 'block';
                emailValidation.style.color = '#dc2626';
                emailValidation.textContent = t('pleaseEnterValidEmail');
                return;
            }
            
            // Extract domain
            const domain = '@' + email.split('@')[1];
            
            // Check if it's a common personal email domain (basic check)
            const personalDomains = ['gmail.com', 'yahoo.com', 'hotmail.com', 'outlook.com', 'icloud.com', 'aol.com'];
            if (personalDomains.some(d => email.toLowerCase().includes('@' + d))) {
                emailValidation.style.display = 'block';
                emailValidation.style.color = '#dc2626';
                emailValidation.textContent = t('pleaseUseUniversityEmail');
                return;
            }
            
            // If it looks like a university email, show positive feedback
            if (email.includes('@student.') || email.includes('@univ.') || email.includes('@edu.')) {
                emailValidation.style.display = 'block';
                emailValidation.style.color = '#10b981';
                emailValidation.textContent = t('universityEmailDetected');
            } else {
                emailValidation.style.display = 'none';
            }
        });
        
        // Load departments on page load
        loadDepartments();
        
        // Google OAuth button
        document.getElementById('btnGoogleAuth').addEventListener('click', function() {
            // Redirect to Google OAuth registration (with action=register parameter)
            window.location.href = 'api/auth/google/login.php?action=register';
        });
        
        // Email registration button
        document.getElementById('btnEmailAuth').addEventListener('click', function() {
            // Redirect to email login page (works for both login and registration)
            window.location.href = 'email_login.html';
        });
        
        // Check if user is coming from Google OAuth
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('google') === '1') {
            // User authenticated with Google, pre-fill form
            const email = urlParams.get('email');
            const name = urlParams.get('name');
            
            if (email) {
                document.getElementById('email').value = email;
                document.getElementById('email').readOnly = true;
                document.getElementById('email').style.background = '#f3f4f6';
            }
            
            if (name) {
                document.getElementById('name').value = name;
            }
            
            // Hide password field for Google auth
            const passwordGroup = document.querySelector('#password').closest('.form-group');
            if (passwordGroup) {
                passwordGroup.style.display = 'none';
            }
            
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = t('googleAuthSuccess');
            errorMessage.style.background = '#f0fdf4';
            errorMessage.style.borderColor = '#10b981';
            errorMessage.style.color = '#059669';
            errorMessage.classList.add('show');
        }
        
        if (urlParams.get('error')) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = decodeURIComponent(urlParams.get('error'));
            errorMessage.classList.add('show');
        }
        
        // Form submission
        document.getElementById('registerForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const name = document.getElementById('name').value.trim();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const department = document.getElementById('department').value.trim();
            const registerBtn = document.getElementById('registerBtn');
            const errorMessage = document.getElementById('errorMessage');
            
            // Check if this is Google OAuth (password field is hidden)
            const passwordGroup = document.querySelector('#password').closest('.form-group');
            const isGoogleAuth = passwordGroup && passwordGroup.style.display === 'none';
            
            // Validation
            if (!name || !email || !department) {
                errorMessage.textContent = t('fillAllFields');
                errorMessage.classList.add('show');
                return;
            }
            
            // Password required only for email registration (not Google OAuth)
            if (!isGoogleAuth && (!password || password.length < 6)) {
                errorMessage.textContent = t('passwordTooShort') || 'Le mot de passe doit contenir au moins 6 caractères';
                errorMessage.classList.add('show');
                return;
            }
            
            // Disable button
            registerBtn.disabled = true;
            registerBtn.textContent = t('registering');
            errorMessage.classList.remove('show');
            
            try {
                // Get current language preference
                const settings = JSON.parse(localStorage.getItem('userSettings') || '{}');
                const language = settings.language || 'fr';
                
                const response = await authAPI.register({
                    name: name,
                    email: email,
                    password: isGoogleAuth ? '' : password, // Empty password for Google OAuth
                    department: department,
                    language: language
                });
                
                if (response.success) {
                    // Check if email is verified
                    if (response.data.email_verified) {
                        // Store user data
                        localStorage.setItem('currentUser', JSON.stringify(response.data.user));
                        localStorage.setItem('authToken', response.data.token);
                        
                        // Redirect to main page
                        window.location.href = 'Test.html';
                    } else {
                        // Email not verified - show message and redirect to login
                        errorMessage.textContent = response.message || t('registerSuccess');
                        errorMessage.style.background = '#f0fdf4';
                        errorMessage.style.borderColor = '#10b981';
                        errorMessage.style.color = '#059669';
                        errorMessage.classList.add('show');
                        
                        // Redirect to login after 3 seconds
                        setTimeout(() => {
                            window.location.href = 'login.html?message=' + encodeURIComponent(t('verifyEmailMessage'));
                        }, 3000);
                    }
                } else {
                    throw new Error(response.message || t('registerFailed'));
                }
            } catch (error) {
                errorMessage.textContent = error.message || t('registerFailedTryAgain');
                errorMessage.classList.add('show');
                registerBtn.disabled = false;
                registerBtn.textContent = t('registerButton');
            }
        });
    </script>
</body>
</html>

